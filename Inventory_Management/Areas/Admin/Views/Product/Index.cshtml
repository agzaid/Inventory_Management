@model List<Domain.Models.ProductVM>

<div class="page-wrapper">
    <div class="page-content">
        <div class="row">
            <div class="col">
                <div class="d-flex justify-content-end mb-1">
                    <a class="btn btn-primary mb-3 mb-lg-0" asp-action="Create" asp-controller="Product">
                        <i class="bx bxs-plus-square"></i>
                        Add New Product
                    </a>
                </div>
                <div class="card radius-10">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="example2" class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Id</th>
                                        <th>Product Name</th>
                                        <th>Product Name Arabic</th>
                                        <th>Details</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Other Shops Price</th>
                                        <th>Qty</th>
                                        <th>Expires At</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td>@item.Id</td>
                                            <td>@item.ProductName</td>
                                            <td>@item.ProductNameAr</td>
                                            <td>@item.Description</td>
                                            <td>@item.CategoryName</td>
                                            <td>@item.SellingPrice</td>
                                            <td>@item.OtherShopsPrice</td>
                                            <td>
                                                <span id="qty-@item.Id" class="badge @(item.StockQuantity < 3 ? "bg-danger" : "bg-success")"
                                                      title="Stock quantity is @(item.StockQuantity < 3 ? "lower than 3" : "sufficient")">
                                                    @item.StockQuantity
                                                </span>
                                            </td>
                                            <td>@item.ExpiryDate</td>
                                            <td>@item.CreatedDate</td>
                                            <td class="text-center" style="font-size:20px">
                                                <a class="me-3" asp-action="Edit" asp-route-id="@item.Id">
                                                    <i class="bx bx-message-square-edit"></i>
                                                </a>
                                                <a class="text-danger me-3" asp-action="Delete" asp-route-id="@item.Id">
                                                    <i class="bx bxs-trash"></i>
                                                </a>
                                                @* only for admins *@
                                                <a class="btn btn-inverse-danger me-3" asp-action="HardDelete" asp-route-id="@item.Id">
                                                    <i class="lni lni-cross-circle" style="margin:auto"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }

                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th>Id</th>
                                        <th>Product Name</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Other Shops Price</th>
                                        <th>Qty</th>
                                        <th>Expires At</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        // build connection with automatic reconnect
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/inventoryHub")
            .withAutomaticReconnect()
            .build();

        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR connected");
            } catch (err) {
                console.error("SignalR failed to start:", err);
                // retry with backoff
                setTimeout(startConnection, 2000);
            }
        }

        connection.onreconnecting(error => {
            console.warn("SignalR reconnecting:", error);
        });

        connection.onreconnected(connectionId => {
            console.log("SignalR reconnected, connectionId:", connectionId);
        });

        connection.onclose(error => {
            console.warn("SignalR connection closed:", error);
        });

        // handle inventory updates
        connection.on("InventoryUpdated", (itemId, newQty) => {
            console.log("InventoryUpdated received:", itemId, newQty);
            const el = document.getElementById(`qty-${itemId}`);
            if (!el) {
                console.warn("Element not found for qty:", `qty-${itemId}`);
                return;
            }

            // update display value
            el.innerText = parseFloat(newQty);

            // update title and badge color (danger if less than 3)
            const qtyNumber = Number(newQty);
            el.title = `Stock quantity is ${qtyNumber < 5 ? "lower than 5" : "sufficient"}`;
            el.classList.toggle("bg-danger", qtyNumber < 5);
            el.classList.toggle("bg-success", qtyNumber >= 5);
        });

        // start
        startConnection();
    </script>
}