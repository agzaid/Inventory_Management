@model Domain.Models.ProductVM

<div class="page-wrapper">
    <div class="page-content">
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-body p-4">
                        <form asp-action="Create" asp-controller="Invoice" id="myForm" enctype="multipart/form-data">
                            <h5 class="card-title">Create Invoice</h5>
                            <hr />
                            <div class="card-body">
                                <div class="fm-search">
                                    <div class="mb-0">
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-transparent"><i class='bx bx-search'></i></span>
                                            <input id="inputSearch" type="text" class="form-control" placeholder="Search the files">
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive text-center mt-3">
                                    <table class="table table-striped table-hover table-sm mb-0" id="listOfPurchases">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th colspan="2">Product Name</th>
                                                <th>Price</th>
                                                <th>Quantity</th>
                                                <th>Available In Stock</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="7" class="no-data-row text-center">
                                                    No products yet...!!!
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row mt-3">
                                    <div class="container col-8">
                                        <div class="mb-3">
                                            <label class="form-label">Customer Name</label>
                                            <input class="form-control" asp-for="ProductName">
                                            <span asp-validation-for="ProductName" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Shipping Notes</label>
                                            <input class="form-control" asp-for="ProductName">
                                            <span asp-validation-for="ProductName" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="align-items-center">
                                            <table class="table table-striped table-hover table-sm mb-0" id="">
                                                <thead>
                                                    <tr>
                                                        <th></th>
                                                        <th></th>

                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-center">
                                                            Total Amount :
                                                        </td>
                                                        <td class="text-center d-flex">
                                                            <div id="totalAmount">--</div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            Order Tax :
                                                        </td>
                                                        <td class="text-center d-flex">
                                                            <div id="orderTax">--</div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            Shipping :
                                                        </td>
                                                        <td class="text-center d-flex">
                                                            <div id="shipping">--</div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            Discount :
                                                        </td>
                                                        <td class="text-center d-flex">
                                                            <div id="discount">--</div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            Grand Total :
                                                        </td>
                                                        <td class="text-center d-flex">
                                                            <div id="grandTotal">--</div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            @* <h5 class="mb-0 font-weight-bold">Social Traffic</h5>
                                            <div class="mb-3 d-flex">
                                                <label class="form-label">Total Amount : </label>
                                                <div class="ms-2" asp-for="ProductName">2342</div>
                                                <span asp-validation-for="ProductName" class="text-danger"></span>
                                            </div> 
                                            <div class="mb-3 d-flex">
                                                <label class="form-label">Order Tax : </label>
                                                <div class="ms-2" asp-for="ProductName">2342</div>
                                                <span asp-validation-for="ProductName" class="text-danger"></span>
                                            </div> 
                                            <div class="mb-3 d-flex">
                                                <label class="form-label">Shipping : </label>
                                                <div class="ms-2" asp-for="ProductName">2342</div>

                                                <span asp-validation-for="ProductName" class="text-danger"></span>
                                            </div> 
                                            <div class="mb-3 d-flex">
                                                <label class="form-label">Discount : </label>
                                                <div class="ms-2" asp-for="ProductName">2342</div>

                                                <span asp-validation-for="ProductName" class="text-danger"></span>
                                            </div> 
                                            <div class="mb-3 d-flex">
                                                <label class="form-label">Grand Total : </label>
                                                <div class="ms-2" asp-for="ProductName">2342</div>

                                                <span asp-validation-for="ProductName" class="text-danger"></span>
                                            </div> *@
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {

          $('#myForm').on('submit', function (event) {
            event.preventDefault();  // Prevents the form from being submitted
            alert("Form submission prevented!");
            });
            $('#ImagesFormFiles').imageuploadify();

            $('#inputSearch').on('change', function() {
                SearchProduct();
            });


        });

         function updateTotalPrice() {
            var totalPrice = 0;

            // Loop through each row to sum the product total prices
            $('.price-input').each(function() {
                debugger;
                var price = parseInt($(this).val());
                var row = $(this).closest('tr');
                var quantity = row.find('.quantity-input').val();
                var productTotal = quantity * price;

                // Update the product's total price in the row
                $('#totalAmount').text('$' + productTotal.toFixed(2));

                // Add to the grand total
                totalPrice += productTotal;
            });

            // Update the total price in the UI
            $('#grandTotal').text('$' + totalPrice.toFixed(2));
        }

        function AddNewRow(data){
            var newRowHtml = `
               <tr>
                   <td></td>
                   <td colspan="2"><div class="d-flex align-items-center">
                       <div>
                           <i class='bx bxs-file-pdf me-2 font-24 text-danger'></i>
                       </div>
                       <div class="font-weight-bold text-danger" id="${data.ProductName}">${data.ProductName}</div></div>
                   </td>
                   <td>
                   ${data.SellingPrice}
                   <input type="text" class="form-control price-input" id="${data.ProductName}-price" value="${data.SellingPrice}" hidden>
                   </td>
                   <td class="col-3"><div>
                           <div class="input-group input-spinner">
                               <button class="btn btn-white" type="button" id="button-plus" onclick="Add(event)"> + </button>
                                <input type="text" class="form-control quantity-input" id="${data.ProductName}-quantity" value="1">
                               <button class="btn btn-white" type="button" id="button-minus" onclick="Decrement(event)"> − </button>
                           </div>
                       </div>
                   </td>
                   <td class="text-danger">${data.StockQuantity}</td>
                   <td><button class="btn btn-inverse-danger" id="deleteBtn" type="button" onclick="Delete(event)">Delete</button></td>
               </tr>
                `;
            $('#listOfPurchases tbody').append(newRowHtml);
            reorderRows();
        };
         function Add(event) {
                    debugger;
                      var addBtn = $(event.target);  // Get the clicked button
                      var inputField = addBtn.siblings('.quantity-input');  // Get the input field that is a sibling of the clicked button

                      // Get the current value of the input field and parse it as an integer
                      var currentValue = parseInt(inputField.val());

                      // Increment the value by 1
                      inputField.val(currentValue + 1);
            };

         function Decrement(event) {
                    debugger;
                   var addBtn = $(event.target);  // Get the clicked button
                   var inputField = addBtn.siblings('.quantity-input');  // Get the input field that is a sibling of the clicked button

                   // Get the current value of the input field and parse it as an integer
                   var currentValue = parseInt(inputField.val());

                   // Decrement the value by 1
                   inputField.val(currentValue - 1);
         };
         function SearchProduct() {
                var query = $('#inputSearch').val();
                // var $url = "@Url.Action("FilterPatientByDate", "Doctor")";
                var $url = "@Url.Action("SearchProduct", "Invoice")";
                var parameter = {
                    data: query
                };
                _Ajax.GETWithParametersStringfy($url, parameter, "GET", function () { },
                    function (data) {
                        var res = JSON.parse(data);
                        if (res != null && res.IsSuccess==true) {
                            AddNewRow(res.Data[0]);
                            checkNoData();
                            updateTotalPrice();
                        } else
                            _SWAL.AlertWithoutNotification(res.Message);
                    },
                    function (xhr) {
                        _SWAL.AlertWithoutNotification("Something went wrong..!!");
                    });
            };
        //window.Delete =
         function Delete(event) {
                 var deleteBtn = $(event.target);
                 var rowToDelete = deleteBtn.closest('tr');
                 rowToDelete.remove();
                 reorderRows();
                 updateTotalPrice();
         };

         function reorderRows() {
             debugger;
               $('#listOfPurchases tbody tr').each(function(index) {
                   // Optionally, reset the row index or any other data you want
                   // Here, we reset the product index or make any adjustments as needed
                   var s = $(this).find('td');
                   $(this).find('td').first().text(index);  // This will reset the first column to show the index number
               });
           }
        function checkNoData() {
        var rows = $('#listOfPurchases tbody tr');

        // If there are no rows (excluding the "No data found yet" row)
        if (rows.length === 1 && rows.hasClass('no-data-row')) {
            // Show the 'No data found yet' message
            $('#listOfPurchases tbody .no-data-row').show();
        } else {
            // If rows are added, remove the "No data found yet" row
            $('#listOfPurchases tbody .no-data-row').remove();
        }
        }
    </script>
}